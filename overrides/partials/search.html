{#
  Hybrid search implementation for Spacelift Documentation
  - Native MkDocs/Lunr.js search for keyword queries (no ?)
  - AutoRAG AI search for questions (ending with ?)
  - Automatic fallback to native search when AutoRAG returns no results
#}

<!-- Search modal -->
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input
        type="text"
        class="md-search__input"
        name="query"
        aria-label="Search"
        placeholder="Search or ask a question (end with ?)"
        autocapitalize="off"
        autocorrect="off"
        autocomplete="off"
        spellcheck="false"
        data-md-component="search-query"
        required
      >
      <label class="md-search__icon md-icon" for="__search">
        {% include ".icons/material/magnify.svg" %}
        {% include ".icons/material/arrow-left.svg" %}
      </label>
      <nav class="md-search__options" aria-label="Search">
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          {% include ".icons/material/close.svg" %}
        </button>
      </nav>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__ai-answer" data-md-component="search-ai-answer" style="display: none;"></div>
          <div class="md-search-result__meta">
            Type to search, or ask a question with ?
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hybrid search JavaScript -->
<script>
  (function() {
    'use strict';

    const SEARCH_API_URL = 'https://laughing-ermine-yhtl.endpoints.useflows.eu/14df920422caccee023d48b64b4ad021';
    const AI_ANSWER_API_URL = 'https://laughing-ermine-yhtl.endpoints.useflows.eu/07dcebed108606dc0fc689e96efbb997';
    const AUTORAG_TIMEOUT_MS = 30000;
    let searchTimeout;
    let searchIndex = null;
    let searchIndexReady = false;

    function log(message, data = null) {
      if (data) {
        console.log(`[Spacelift Search] ${message}`, data);
      } else {
        console.log(`[Spacelift Search] ${message}`);
      }
    }

    let searchIndexLoading = null;
    
    async function loadSearchIndex() {
      if (searchIndexReady) return true;
      if (searchIndexLoading) return searchIndexLoading;
      
      searchIndexLoading = (async () => {
        const possiblePaths = [
          'search/search_index.json',
          '/search/search_index.json',
          './search/search_index.json'
        ];
        
        for (const path of possiblePaths) {
          try {
            const url = new URL(path, window.location.href).href;
            log('Trying search index at:', url);
            
            const response = await fetch(url);
            if (response.ok) {
              searchIndex = await response.json();
              searchIndexReady = true;
              log('Search index loaded successfully', { docs: searchIndex.docs?.length || 0 });
              return true;
            }
          } catch (error) {
            log('Failed to load from path:', path);
          }
        }
        
        log('Could not load search index from any path');
        searchIndexReady = false;
        return false;
      })();
      
      return searchIndexLoading;
    }

    async function performNativeSearch(query, isFallback = false) {
      const resultContainer = document.querySelector('[data-md-component="search-result"]');
      const resultMeta = resultContainer.querySelector('.md-search-result__meta');
      const resultList = resultContainer.querySelector('.md-search-result__list');
      const aiAnswerContainer = document.querySelector('[data-md-component="search-ai-answer"]');

      if (!isFallback && aiAnswerContainer) {
        aiAnswerContainer.style.display = 'none';
        aiAnswerContainer.innerHTML = '';
      }

      if (!searchIndexReady) {
        resultMeta.textContent = 'Loading search index...';
        await loadSearchIndex();
      }
      
      if (!searchIndexReady || !searchIndex || !searchIndex.docs) {
        resultMeta.textContent = 'Search index not available. Try asking a question with ?';
        resultList.innerHTML = '';
        log('Native search failed: index not ready');
        return;
      }

      trackSearch(query, isFallback ? 'fallback' : 'native');
      
      const queryLower = query.toLowerCase();
      const queryTerms = queryLower.split(/\s+/).filter(term => term.length > 1);
      
      log('Performing native search', { query, terms: queryTerms, isFallback });

      const results = searchIndex.docs
        .map(doc => {
          const titleLower = (doc.title || '').toLowerCase();
          const textLower = (doc.text || '').toLowerCase();
          const locationLower = (doc.location || '').toLowerCase();
          
          let score = 0;
          
          queryTerms.forEach(term => {
            if (titleLower.includes(term)) score += 10;
            if (locationLower.includes(term)) score += 5;
            if (textLower.includes(term)) score += 1;
            
            if (titleLower === term) score += 20;
            if (titleLower.startsWith(term)) score += 5;
          });
          
          if (titleLower.includes(queryLower)) score += 15;
          if (textLower.includes(queryLower)) score += 3;
          
          return { ...doc, score };
        })
        .filter(doc => doc.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 20);

      log('Native search results', { count: results.length, results: results });
      displayResults(results, query, resultMeta, resultList, 'native');
    }

    function fetchAIAnswer(query) {
      const aiAnswerContainer = document.querySelector('[data-md-component="search-ai-answer"]');
      const resultMeta = document.querySelector('.md-search-result__meta');
      if (!aiAnswerContainer) return;
      
      aiAnswerContainer.style.display = 'none';
      aiAnswerContainer.innerHTML = '';
      
      log('Fetching AI answer for:', query);
      
      fetch(`${AI_ANSWER_API_URL}?q=${encodeURIComponent(query)}`)
        .then(response => {
          if (!response.ok) throw new Error(`API returned ${response.status}`);
          return response.text();
        })
        .then(answer => {
          log('AI answer received', { answer });
          if (resultMeta) {
            resultMeta.classList.remove('md-search-result__meta--ai-loading');
          }
          if (answer && answer.trim()) {
            aiAnswerContainer.innerHTML = `
              <div class="md-search-result__ai-answer-content">${answer.trim()}</div>
              <div class="md-search-result__ai-disclaimer">AI-generated response may be inaccurate. Always verify with the documentation.</div>
            `;
            aiAnswerContainer.style.display = 'block';
          }
        })
        .catch(error => {
          log('AI answer fetch failed:', error);
          if (resultMeta) {
            resultMeta.classList.remove('md-search-result__meta--ai-loading');
          }
        });
    }

    async function performAutoRAGSearch(query) {
      const resultContainer = document.querySelector('[data-md-component="search-result"]');
      const resultMeta = resultContainer.querySelector('.md-search-result__meta');
      const resultList = resultContainer.querySelector('.md-search-result__list');
      const aiAnswerContainer = document.querySelector('[data-md-component="search-ai-answer"]');

      if (aiAnswerContainer) {
        aiAnswerContainer.style.display = 'none';
        aiAnswerContainer.innerHTML = '';
      }

      trackSearch(query, 'autorag');
      resultMeta.textContent = 'Searching with AI...';
      resultMeta.classList.add('md-search-result__meta--loading');

      log('Performing AutoRAG search', { query, timeout: AUTORAG_TIMEOUT_MS });

      fetchAIAnswer(query);

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), AUTORAG_TIMEOUT_MS);

        const response = await fetch(
          `${SEARCH_API_URL}?q=${encodeURIComponent(query)}`,
          { signal: controller.signal }
        );

        clearTimeout(timeoutId);
        resultMeta.classList.remove('md-search-result__meta--loading');

        if (!response.ok) {
          throw new Error(`API returned ${response.status}`);
        }

        const data = await response.json();
        const results = data.docs || [];

        log('AutoRAG search results', { count: results.length, results: results });

        if (results.length === 0) {
          resultMeta.textContent = 'No AI results, trying keyword search...';
          log('AutoRAG returned no results, falling back to native search');
          setTimeout(() => {
            const queryWithoutQuestion = query.replace(/\?+$/, '').trim();
            performNativeSearch(queryWithoutQuestion, true);
          }, 500);
          return;
        }

        displayResults(results, query, resultMeta, resultList, 'autorag');
      } catch (error) {
        resultMeta.classList.remove('md-search-result__meta--loading');
        
        if (error.name === 'AbortError') {
          log('AutoRAG search timed out, falling back to native search');
          resultMeta.textContent = 'AI search timed out, using keyword search...';
        } else {
          log('AutoRAG search error, falling back to native search', error);
          resultMeta.textContent = 'AI search unavailable, using keyword search...';
        }

        setTimeout(() => {
          const queryWithoutQuestion = query.replace(/\?+$/, '').trim();
          performNativeSearch(queryWithoutQuestion, true);
        }, 500);
      }
    }

    function displayResults(results, query, metaElement, listElement, searchType) {
      if (results.length === 0) {
        metaElement.textContent = 'No results found';
        listElement.innerHTML = '';
        return;
      }

      const typeLabel = searchType === 'autorag' ? ' (AI)' : '';
      const aiAnswerLoading = searchType === 'autorag' ? ' · <span class="md-search-result__ai-answer-loading">Generating answer...</span>' : '';
      const aiHint = searchType !== 'autorag' ? ' · <span class="md-search-result__ai-hint">Add <kbd>?</kbd> for AI search</span>' : '';
      
      if (searchType === 'autorag') {
        metaElement.classList.add('md-search-result__meta--ai-loading');
      }
      
      metaElement.innerHTML = `${results.length} result${results.length !== 1 ? 's' : ''}${typeLabel}${aiAnswerLoading}${aiHint}`;

      listElement.innerHTML = results.map(result => {
        const title = result.title || 'Untitled';
        const text = result.text || '';
        let location = result.location || '#';
        if (location !== '#' && !location.startsWith('/') && !location.startsWith('http')) {
          location = '/' + location;
        }

        const displayTitle = searchType === 'autorag' 
          ? highlightText(title, query)
          : highlightText(title, query.replace(/\?+$/, ''));
        
        const displayText = text 
          ? highlightText(truncateText(text, 200), query.replace(/\?+$/, ''))
          : '';

        return `
          <li class="md-search-result__item">
            <a href="${escapeHtml(location)}" class="md-search-result__link" tabindex="-1">
              <article class="md-search-result__article md-typeset" data-md-score="${result.score || 1}">
                <h1>${displayTitle}</h1>
                ${displayText ? `<p>${displayText}</p>` : ''}
              </article>
            </a>
          </li>
        `;
      }).join('');
    }

    function highlightText(text, query) {
      if (!query || !text) return escapeHtml(text);
      
      const cleanQuery = query.replace(/\?+$/, '').trim();
      if (!cleanQuery) return escapeHtml(text);
      
      const terms = cleanQuery.split(/\s+/).filter(t => t.length > 1);
      if (terms.length === 0) return escapeHtml(text);
      
      let escaped = escapeHtml(text);
      
      terms.forEach(term => {
        const regex = new RegExp(`(${escapeRegex(term)})`, 'gi');
        escaped = escaped.replace(regex, '<mark>$1</mark>');
      });
      
      return escaped;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function truncateText(text, maxLength) {
      const stripped = text.replace(/<[^>]*>/g, '');
      if (stripped.length <= maxLength) return stripped;
      return stripped.substring(0, maxLength).trim() + '...';
    }

    function trackSearch(query, searchType) {
      if (window.dataLayer) {
        window.dataLayer.push({
          event: 'search',
          searchTerm: query,
          searchType: searchType
        });
        log('GTM tracking', { query, searchType });
      }

      if (window.analytics && typeof window.analytics.track === 'function') {
        window.analytics.track('Search', {
          query: query,
          type: searchType
        });
        log('Segment tracking', { query, searchType });
      }
    }

    function initHybridSearch() {
      const searchInput = document.querySelector('[data-md-component="search-query"]');
      const resultContainer = document.querySelector('[data-md-component="search-result"]');

      if (!searchInput || !resultContainer) {
        log('Search elements not found, skipping initialization');
        return;
      }

      const resultMeta = resultContainer.querySelector('.md-search-result__meta');
      const resultList = resultContainer.querySelector('.md-search-result__list');

      loadSearchIndex();

      searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();

        clearTimeout(searchTimeout);

        const aiAnswerContainer = document.querySelector('[data-md-component="search-ai-answer"]');
        
        if (query.length === 0) {
          resultMeta.textContent = 'Type to search, or ask a question with ?';
          resultMeta.classList.remove('md-search-result__meta--loading');
          resultList.innerHTML = '';
          if (aiAnswerContainer) {
            aiAnswerContainer.style.display = 'none';
            aiAnswerContainer.innerHTML = '';
          }
          return;
        }

        const isQuestion = query.endsWith('?');

        if (isQuestion && query.length < 4) {
          resultMeta.textContent = 'Question too short';
          resultList.innerHTML = '';
          return;
        }

        if (!isQuestion && query.length < 2) {
          resultMeta.textContent = 'Type more to search...';
          resultList.innerHTML = '';
          return;
        }

        resultMeta.textContent = isQuestion ? 'Searching with AI...' : 'Searching...';
        if (isQuestion) {
          resultMeta.classList.add('md-search-result__meta--loading');
        }

        searchTimeout = setTimeout(() => {
          if (isQuestion) {
            performAutoRAGSearch(query);
          } else {
            performNativeSearch(query);
          }
        }, 300);
      });

      const resetButton = document.querySelector('.md-search__form button[type="reset"]');
      if (resetButton) {
        resetButton.addEventListener('click', function() {
          const aiAnswerContainer = document.querySelector('[data-md-component="search-ai-answer"]');
          resultMeta.textContent = 'Type to search, or ask a question with ?';
          resultMeta.classList.remove('md-search-result__meta--loading');
          resultList.innerHTML = '';
          if (aiAnswerContainer) {
            aiAnswerContainer.style.display = 'none';
            aiAnswerContainer.innerHTML = '';
          }
        });
      }

      log('Hybrid search initialized');
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initHybridSearch);
    } else {
      initHybridSearch();
    }

    if (typeof location$ !== 'undefined') {
      location$.subscribe(function() {
        setTimeout(initHybridSearch, 100);
      });
    }
  })();
</script>
